update_predictions <- function(labelled, unlabelled, verbose = FALSE, plot = FALSE) {

  defaultW <- getOption("warn")
  
  # Calculate maximal impact speed per case.
  maximpact0 <- labelled %>%
    group_by(caseID) %>%
    summarise(maximpact0 = max(impact_speed0, na.rm = TRUE), .groups = "keep") %>%
    ungroup() %>%
    dplyr::select(caseID, maximpact0)

  labelled %<>%
    left_join(maximpact0, by = "caseID") %>% 
    mutate(sampling_weight = ifelse(sampling_weight == 0, 1, sampling_weight), # Set sampling weight of certainty-selections to unity.
           final_weight = sampling_weight * eoff_acc_prob)
  labelled$caseID <- factor(labelled$caseID)
  
  unlabelled %<>%
    left_join(maximpact0, by = "caseID") 
  unlabelled$caseID <- factor(unlabelled$caseID)
  

  # Hyper-parameter tuning grid for random forest regression and classification.
  regGrid <- expand.grid(splitrule = "variance", 
                         min.node.size = 1:20,
                         mtry = 1:3)
  
  classGrid <- expand.grid(splitrule = "gini", 
                           min.node.size = 1:20,
                           mtry = 1:3)

  
  # Predict baseline impact speed. ----
  
  # Train random forest.  
  options(warn = -1)
  grid <- regGrid[sample(1:nrow(regGrid), 3), ]
  rf <- safe_caret_train(impact_speed0 ~ eoff + acc + maximpact0, 
                         data = labelled,
                         method = "ranger",
                         num.trees = 100,
                         tuneGrid = grid,
                         trControl = trainControl(method = "cv",
                                                  number = 5))
  options(warn = defaultW)
  
  if ( !is.null(rf) ) { # If able to fit model: calculate predictions.
    
    # Prediction on labelled and unlabelled data.
    xhat_train <- predict(rf, labelled)
    xhat_test <- predict(rf, unlabelled)

    # Root mean squared prediction error and prediction R-squared.
    rmse_xhat <- sqrt(rf$finalModel$prediction.error) 
    r2_xhat <- rf$finalModel$r.squared
    
  } else { # If unable to fit model: set to constant.
    
    xhat_train <- 1
    xhat_test <- 1
    rmse_xhat <- NA
    r2_xhat <- NA
    
  }
  
  labelled$impact_speed0_pred <- xhat_train
  unlabelled$impact_speed0_pred <- xhat_test
  
 
  # Predict impact speed reduction ----
  
  # Train random forest.  
  options(warn = -1)
  grid <- regGrid[sample(1:nrow(regGrid), 3), ]
  rf <- safe_caret_train(impact_speed_reduction ~ eoff + acc + impact_speed0_pred, 
                         data = labelled,
                         method = "ranger",
                         num.trees = 100,
                         tuneGrid = grid,
                         trControl = trainControl(method = "cv",
                                                  number = 5))
  options(warn = defaultW)
  
  if ( !is.null(rf) ) { # If able to fit model: calculate predictions.
    
    # Prediction on labelled and unlabelled data.
    yhat_train <- predict(rf, labelled)
    yhat_test <- predict(rf, unlabelled)
    
    # Root mean squared prediction error and prediction R-squared.
    rmse_yhat <- sqrt(rf$finalModel$prediction.error) 
    r2_yhat <- rf$finalModel$r.squared
    
  } else { # If unable to fit model: set to constant.
    
    yhat_train <- 1
    yhat_test <- 1
    rmse_yhat <- NA
    r2_yhat <- NA
    
  }

  
  # Predict injury risk reduction. ----
  
  # Train random forest.  
  options(warn = -1)
  grid <- regGrid[sample(1:nrow(regGrid), 3), ]
  rf <- safe_caret_train(injury_risk_reduction ~ eoff + acc + impact_speed0_pred, 
                         data = labelled,
                         method = "ranger",
                         num.trees = 100,
                         respect.unordered.factors = "partition",
                         tuneGrid = grid,
                         trControl = trainControl(method = "cv",
                                                  number = 5))
  options(warn = defaultW)
  
  if ( !is.null(rf) ) { # If able to fit model: calculate predictions.

    # Prediction on labelled and unlabelled data.
    zhat_train <- predict(rf, labelled)
    zhat_test <- predict(rf, unlabelled)

    # Root mean squared prediction error and prediction R-squared.
    rmse_zhat <- sqrt(rf$finalModel$prediction.error) 
    r2_zhat <- rf$finalModel$r.squared
    
  } else { # If unable to fit model: set to constant.
    
    zhat_train <- 1
    zhat_test <- 1
    rmse_zhat <- NA
    r2_zhat <- NA
    
  }

 
  # Estimate counter-measure collision probability. ----
  
  # Train random forest.  
  options(warn = -1)
  grid <- classGrid[sample(1:nrow(classGrid), 3), ]
  rf <- safe_caret_train(factor(impact_speed1 > 0, labels = paste0("Y", 0:1)) ~ eoff + acc + impact_speed0_pred, 
                         data = labelled,
                         method = "ranger",
                         num.trees = 100,
                         tuneGrid = grid,
                         trControl = trainControl(method = "cv",
                                                  number = 5,
                                                  classProbs = TRUE))
  options(warn = defaultW)
  
  if ( !is.null(rf) ) { # If able to fit model: calculate predictions.
    
    # Prediction on labelled and unlabelled data.
    p1_train <- predict(rf, labelled, type = "prob")$Y1
    p1_train[p1_train <= 0] <- min(p1_train[p1_train > 0]) # Avoid zero probabilities.
    
    p1_test <- predict(rf, unlabelled, type = "prob")$Y1
    p1_test[p1_test <= 0] <- min(p1_test[p1_test > 0]) # Avoid zero probabilities.
    
    # Accuracy.
    ix <- with(rf$results, which(min.node.size == rf$finalModel$min.node.size & mtry == rf$finalModel$mtry))
    p1_acc <- rf$results[ix, "Accuracy"]
    
  } else { # If unable to fit model: set to constant.
    
      p1_train <- 1
      p1_test <- 1
      p1_acc <- NA
    
  } # End !is.null(rf).
  
  
  # Combine to calculate predictions on labelled  data. 
  labelled %<>%
    mutate(impact_speed0_pred = xhat_train, 
           impact_speed_reduction_pred = yhat_train, 
           injury_risk_reduction_pred = zhat_train, 
           collision_prob1_pred = p1_train) 
  
   # Print.
  if ( verbose ) {
    
    cat(sprintf("Out-of-bag R-squared:
Baseline impact speed = %.2f
Impact speed reduction = %.2f
Injury risk reduction = %.2f.

Out-of-bag Accuracy:
Counter-meature crash probability = %.2f.
                ", 
                r2_xhat, 
                r2_yhat,
                r2_zhat,
                p1_acc))
    cat("\n")
    
  }
  
  
  # Add logic.
  p1_test <- pmax(p1_test, unlabelled$crash1, na.rm = TRUE)  # Certainty crashes.
  p1_test <- pmin(p1_test, 1 - unlabelled$non_crash1, na.rm = TRUE)  # Certainty non-crashes.
  xhat_test <- with(unlabelled, ifelse(!is.na(max_impact0) & max_impact0 == 1, maximpact0, xhat_test)) # Certainty maximal impact speed crashes. 
  xhat_test <- pmin(unlabelled$maximpact0, xhat_test) # Predictions should not exceed known maximum impact speed.
  
  
  # Plot.
  if ( plot ) {
    par(mfrow = c(1, 3))
    plot(labelled$impact_speed0_pred, labelled$impact_speed0, bty = "l", col = labelled$caseID, xlim = range(labelled$impact_speed0))
    abline(0, 1)
    plot(labelled$eoff, labelled$impact_speed0, bty = "l", col = labelled$caseID)
    plot(labelled$eoff, labelled$impact_speed0_pred, bty = "l", col = labelled$caseID, ylim = range(labelled$impact_speed0))
    
    plot(labelled$impact_speed_reduction_pred, labelled$impact_speed_reduction, bty = "l", col = labelled$caseID, xlim = range(labelled$impact_speed_reduction))
    abline(0, 1)
    plot(labelled$eoff, labelled$impact_speed_reduction, bty = "l", col = labelled$caseID)
    plot(labelled$eoff, labelled$impact_speed_reduction_pred, bty = "l", col = labelled$caseID, ylim = range(labelled$impact_speed_reduction))
    
    plot(labelled$injury_risk_reduction_pred, labelled$injury_risk_reduction, bty = "l", col = labelled$caseID, xlim = range(labelled$injury_risk_reduction))
    abline(0, 1)
    plot(labelled$eoff, labelled$injury_risk_reduction, bty = "l", col = labelled$caseID)
    plot(labelled$eoff, labelled$injury_risk_reduction_pred, bty = "l", col = labelled$caseID, ylim = range(labelled$injury_risk_reduction))
    
    par(mfrow = c(1, 1))
    plot(labelled$collision_prob1_pred, labelled$impact_speed1 > 0, bty = "l")
    
    
    par(mfrow = c(1, 3))
    plot(xhat_test, unlabelled$impact_speed0, bty = "l", col = unlabelled$caseID, xlim = range(unlabelled$impact_speed0))
    abline(lm(unlabelled$impact_speed0~xhat_test), col = "red", lty = 2)
    abline(0, 1, lwd = 2)
    plot(unlabelled$eoff, unlabelled$impact_speed0, bty = "l", col = unlabelled$caseID)
    plot(unlabelled$eoff, xhat_test, bty = "l", col = unlabelled$caseID, ylim = range(unlabelled$impact_speed0))
    
    plot(yhat_test, unlabelled$impact_speed_reduction, bty = "l", col = unlabelled$caseID, xlim = range(unlabelled$impact_speed_reduction))
    abline(lm(unlabelled$impact_speed_reduction~yhat_test), col = "red", lty = 2)
    abline(0, 1, lwd = 2)
    plot(unlabelled$eoff, unlabelled$impact_speed_reduction, bty = "l", col = unlabelled$caseID)
    plot(unlabelled$eoff, yhat_test, bty = "l", col = unlabelled$caseID, ylim = range(unlabelled$impact_speed_reduction))
    
    plot(zhat_test, unlabelled$injury_risk_reduction, bty = "l", col = unlabelled$caseID, xlim = range(unlabelled$injury_risk_reduction))
    abline(lm(unlabelled$injury_risk_reduction~zhat_test), col = "red", lty = 2)
    abline(0, 1, lwd = 2)
    plot(unlabelled$eoff, unlabelled$injury_risk_reduction, bty = "l", col = unlabelled$caseID)
    plot(unlabelled$eoff, zhat_test, bty = "l", col = unlabelled$caseID, ylim = range(unlabelled$injury_risk_reduction))
    
    par(mfrow = c(1, 1))
    plot(p1_test, unlabelled$impact_speed1 > 0, bty = "l")
    abline(lm(unlabelled$impact_speed1 > 0 ~ p1_test))
    
  }
  
  
  # Return.
  rmse_log_xhat <- with(labelled %>% filter(impact_speed0 > 0), sd(log(impact_speed0) - log(impact_speed0_pred)))
  return(list(collision_prob1 = p1_test,
              impact_speed0_pred = xhat_test,
              impact_speed_reduction_pred = yhat_test,
              injury_risk_reduction_pred = zhat_test,
              rmse_log_impact_speed0 = rmse_log_xhat,
              rmse_impact_speed_reduction = rmse_yhat,
              rmse_injury_risk_reduction = rmse_zhat,
              r2_impact_speed0 = r2_xhat,
              r2_impact_speed_reduction = r2_yhat,
              r2_injury_risk_reduction = r2_zhat,
              accuracy_crash1 = p1_acc))
  
}